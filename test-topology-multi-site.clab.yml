name: test-multi-site-topology
topology:
  nodes:

    # ── Site 1 — Subnet A (10.0.1.0/24) ─────────────────────────────
    s1n1-router:
      kind: linux
      image: frrouting/frr:latest
      group: Site 1
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - ip addr add 10.0.1.1/24 dev eth1
    s1n1-switch:
      kind: linux
      image: alpine:latest
      group: Site 1
      exec:
        - ip link add br0 type bridge
        - ip link set br0 up
        - ip link set eth1 master br0
        - ip link set eth2 master br0
        - ip link set eth3 master br0
        - ip addr add 10.0.1.2/24 dev br0
        - ip route replace default via 10.0.1.1
    s1n1-ws1:
      kind: linux
      image: alpine:latest
      group: Site 1
      exec:
        - ip addr add 10.0.1.3/24 dev eth1
        - ip route replace default via 10.0.1.1
    s1n1-ws2:
      kind: linux
      image: alpine:latest
      group: Site 1
      exec:
        - ip addr add 10.0.1.4/24 dev eth1
        - ip route replace default via 10.0.1.1

    # ── Site 1 — Subnet B (10.0.2.0/24) ─────────────────────────────
    s1n2-router:
      kind: linux
      image: frrouting/frr:latest
      group: Site 1
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - ip addr add 10.0.2.1/24 dev eth1
    s1n2-switch:
      kind: linux
      image: alpine:latest
      group: Site 1
      exec:
        - ip link add br0 type bridge
        - ip link set br0 up
        - ip link set eth1 master br0
        - ip link set eth2 master br0
        - ip link set eth3 master br0
        - ip addr add 10.0.2.2/24 dev br0
        - ip route replace default via 10.0.2.1
    s1n2-ws1:
      kind: linux
      image: alpine:latest
      group: Site 1
      exec:
        - ip addr add 10.0.2.3/24 dev eth1
        - ip route replace default via 10.0.2.1
    s1n2-ws2:
      kind: linux
      image: alpine:latest
      group: Site 1
      exec:
        - ip addr add 10.0.2.4/24 dev eth1
        - ip route replace default via 10.0.2.1

    # ── Site 2 — Subnet A (10.1.1.0/24) ─────────────────────────────
    s2n1-router:
      kind: linux
      image: frrouting/frr:latest
      group: Site 2
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - ip addr add 10.1.1.1/24 dev eth1
    s2n1-switch:
      kind: linux
      image: alpine:latest
      group: Site 2
      exec:
        - ip link add br0 type bridge
        - ip link set br0 up
        - ip link set eth1 master br0
        - ip link set eth2 master br0
        - ip link set eth3 master br0
        - ip addr add 10.1.1.2/24 dev br0
        - ip route replace default via 10.1.1.1
    s2n1-ws1:
      kind: linux
      image: alpine:latest
      group: Site 2
      exec:
        - ip addr add 10.1.1.3/24 dev eth1
        - ip route replace default via 10.1.1.1
    s2n1-ws2:
      kind: linux
      image: alpine:latest
      group: Site 2
      exec:
        - ip addr add 10.1.1.4/24 dev eth1
        - ip route replace default via 10.1.1.1

    # ── Site 2 — Subnet B (10.1.2.0/24) ─────────────────────────────
    s2n2-router:
      kind: linux
      image: frrouting/frr:latest
      group: Site 2
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - ip addr add 10.1.2.1/24 dev eth1
    s2n2-switch:
      kind: linux
      image: alpine:latest
      group: Site 2
      exec:
        - ip link add br0 type bridge
        - ip link set br0 up
        - ip link set eth1 master br0
        - ip link set eth2 master br0
        - ip link set eth3 master br0
        - ip addr add 10.1.2.2/24 dev br0
        - ip route replace default via 10.1.2.1
    s2n2-ws1:
      kind: linux
      image: alpine:latest
      group: Site 2
      exec:
        - ip addr add 10.1.2.3/24 dev eth1
        - ip route replace default via 10.1.2.1
    s2n2-ws2:
      kind: linux
      image: alpine:latest
      group: Site 2
      exec:
        - ip addr add 10.1.2.4/24 dev eth1
        - ip route replace default via 10.1.2.1

    # ── Site 3 — Subnet A (10.2.1.0/24) — 1 workstation ─────────────
    s3n1-router:
      kind: linux
      image: frrouting/frr:latest
      group: Site 3
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - ip addr add 10.2.1.1/24 dev eth1
    s3n1-switch:
      kind: linux
      image: alpine:latest
      group: Site 3
      exec:
        - ip link add br0 type bridge
        - ip link set br0 up
        - ip link set eth1 master br0
        - ip link set eth2 master br0
        - ip addr add 10.2.1.2/24 dev br0
        - ip route replace default via 10.2.1.1
    s3n1-ws1:
      kind: linux
      image: alpine:latest
      group: Site 3
      exec:
        - ip addr add 10.2.1.3/24 dev eth1
        - ip route replace default via 10.2.1.1

  links:
    # Site 1 — Subnet A
    - endpoints: ["s1n1-switch:eth1", "s1n1-router:eth1"]
    - endpoints: ["s1n1-switch:eth2", "s1n1-ws1:eth1"]
    - endpoints: ["s1n1-switch:eth3", "s1n1-ws2:eth1"]
    # Site 1 — Subnet B
    - endpoints: ["s1n2-switch:eth1", "s1n2-router:eth1"]
    - endpoints: ["s1n2-switch:eth2", "s1n2-ws1:eth1"]
    - endpoints: ["s1n2-switch:eth3", "s1n2-ws2:eth1"]
    # Site 2 — Subnet A
    - endpoints: ["s2n1-switch:eth1", "s2n1-router:eth1"]
    - endpoints: ["s2n1-switch:eth2", "s2n1-ws1:eth1"]
    - endpoints: ["s2n1-switch:eth3", "s2n1-ws2:eth1"]
    # Site 2 — Subnet B
    - endpoints: ["s2n2-switch:eth1", "s2n2-router:eth1"]
    - endpoints: ["s2n2-switch:eth2", "s2n2-ws1:eth1"]
    - endpoints: ["s2n2-switch:eth3", "s2n2-ws2:eth1"]
    # Site 3 — Subnet A
    - endpoints: ["s3n1-switch:eth1", "s3n1-router:eth1"]
    - endpoints: ["s3n1-switch:eth2", "s3n1-ws1:eth1"]
