name: alpine-ovs-lab

topology:
  nodes:
    # === Routers ===
    router1:
      kind: linux
      image: frrouting/frr:latest
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - ip addr add 10.0.1.1/24 dev eth1
        - ip addr add 10.0.0.1/30 dev eth2
        - ip route add 10.0.2.0/24 via 10.0.0.2

    router2:
      kind: linux
      image: frrouting/frr:latest
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - ip addr add 10.0.2.1/24 dev eth1
        - ip addr add 10.0.0.2/30 dev eth2
        - ip route add 10.0.1.0/24 via 10.0.0.1

    # === Switches ===
    switch1:
      kind: linux
      image: tollan/openvswitch-xp:v0.1
      exec:
        - ovs-vsctl add-br br0
        - ovs-vsctl add-port br0 eth1
        - ovs-vsctl add-port br0 eth2
        - ovs-vsctl add-port br0 eth3
        - ip link set br0 up

    switch2:
      kind: linux
      image: tollan/openvswitch-xp:v0.1
      exec:
        - ovs-vsctl add-br br0
        - ovs-vsctl add-port br0 eth1
        - ovs-vsctl add-port br0 eth2
        - ovs-vsctl add-port br0 eth3
        - ip link set br0 up

    # === Hosts ===
    alpine1:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 10.0.1.10/24 dev eth1
        - ip route add 10.0.2.0/24 via 10.0.1.1

    alpine2:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 10.0.1.20/24 dev eth1
        - ip route add 10.0.2.0/24 via 10.0.1.1

    alpine3:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 10.0.2.10/24 dev eth1
        - ip route add 10.0.1.0/24 via 10.0.2.1

    alpine4:
      kind: linux
      image: alpine:latest
      exec:
        - ip addr add 10.0.2.20/24 dev eth1
        - ip route add 10.0.1.0/24 via 10.0.2.1

  links:
    # Router-to-Router (point-to-point 10.0.0.0/30)
    - endpoints: ["router1:eth2", "router2:eth2"]

    # Router1 to Switch1
    - endpoints: ["router1:eth1", "switch1:eth1"]

    # Router2 to Switch2
    - endpoints: ["router2:eth1", "switch2:eth1"]

    # Hosts on Switch1 (LAN1: 10.0.1.0/24)
    - endpoints: ["alpine1:eth1", "switch1:eth2"]
    - endpoints: ["alpine2:eth1", "switch1:eth3"]

    # Hosts on Switch2 (LAN2: 10.0.2.0/24)
    - endpoints: ["alpine3:eth1", "switch2:eth2"]
    - endpoints: ["alpine4:eth1", "switch2:eth3"]